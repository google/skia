name: Skia Static Build (Windows x64 Debug & Release, m142, UI Advanced, No DLL)

on:
  workflow_dispatch:
    inputs:
      skia_version:
        description: 'Skia tag/branch to build'
        required: false
        default: 'm142'
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        config: [Debug, Release]

    steps:
      # 1. 拉取指定版本 Skia
      - name: Checkout Skia source
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.skia_version || 'm142' }}
          submodules: false
          fetch-depth: 0
          clean: true

      # 2. 安装 Ninja
      - name: Install Ninja
        shell: pwsh
        run: choco install -y ninja --no-progress

      # 3. 安装 vcpkg（用于第三方静态库，首次自助安装）
      - name: Setup vcpkg
        shell: pwsh
        run: |
          $vcpkgRoot = "C:\vcpkg"
          if (-not (Test-Path $vcpkgRoot)) {
            git clone https://github.com/microsoft/vcpkg $vcpkgRoot
            & "$vcpkgRoot\bootstrap-vcpkg.bat" -disableMetrics
          }

      # 4. 用 vcpkg 安装必需库（静态，无 DLL，无 webp）
      - name: Install system libraries via vcpkg
        shell: pwsh
        run: |
          & "C:\vcpkg\vcpkg.exe" install `
            libjpeg-turbo:x64-windows-static `
            libpng:x64-windows-static `
            freetype:x64-windows-static `
            harfbuzz:x64-windows-static `
            zlib:x64-windows-static `
            --triplet x64-windows-static

      # 5. CMake 配置 Skia，支持高级UI+GPU
      - name: Configure Skia via CMake
        shell: pwsh
        run: |
          mkdir build
          cd build
          cmake .. -G "Ninja" `
            -DSKIA_BUILD_FOR_WIN=ON `
            -DSKIA_BUILD_SHARED_LIBS=OFF `
            -DSKIA_ENABLE_GPU=ON `
            -DSKIA_USE_SYSTEM_LIBJPEG=ON `
            -DSKIA_USE_SYSTEM_LIBPNG=ON `
            -DSKIA_USE_SYSTEM_ZLIB=ON `
            -DSKIA_USE_SYSTEM_FREETYPE=ON `
            -DSKIA_USE_SYSTEM_HARFBUZZ=ON `
            -DSKIA_USE_SYSTEM_WEBP=OFF `
            -DSKIA_ENABLE_SVG=ON `
            -DCMAKE_BUILD_TYPE=${{ matrix.config }} `
            -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" `
            -DSKIA_ENABLE_SKOTTIE=ON `
            -DSKIA_ENABLE_DND=ON `
            -DSKIA_ENABLE_SKSHAPER=ON `
            -DSKIA_ENABLE_PARAGRAPH=ON `
            -DSKIA_ENABLE_EFFECTS=ON `
            -DSKIA_ENABLE_FILTERS=ON

      # 6. Ninja 编译 Skia 静态库
      - name: Build Skia static lib
        shell: pwsh
        run: |
          cd build
          ninja

      # 7. 打包静态库+头文件
      - name: Package ${{ matrix.config }}
        shell: pwsh
        run: |
          $outDir = "package/${{ matrix.config }}"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          # Skia主库名以实际输出为准（一般为 skia.lib 或 libskia.a 或 skia_static.lib）
          $skiaLib = Get-ChildItem -Path build -Filter "*skia*.lib" | Select-Object -First 1
          if ($skiaLib -eq $null) { throw "Cannot find skia static lib after build." }
          Copy-Item $skiaLib.FullName -Destination "$outDir/skia.lib" -ErrorAction Stop
          robocopy "include" "$outDir/include" /E /NP /NFL /NDL | Out-Null
        continue-on-error: true

      # 8. 上传产物
      - name: Upload Artifact ${{ matrix.config }}
        uses: actions/upload-artifact@v4
        with:
          name: skia-windows-x64-static-${{ matrix.config }}-m142
          path: package/${{ matrix.config }}
